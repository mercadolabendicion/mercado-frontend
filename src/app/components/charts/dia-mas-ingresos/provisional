import {
  Component,
  ViewChild,
  ElementRef,
  AfterViewInit,
  OnDestroy,
  Input,
  OnChanges,
  SimpleChanges,
} from '@angular/core';
import { createChartEx, BaselineSeries, IChartApi } from 'lightweight-charts';
import { HorzScaleBehaviorWeek } from './horz-scale-week';

interface VentaPorDia {
  diaSemana: string;
  numeroDia: number;
  cantidadVentas: number;
  totalVentas: number;
}

@Component({
  selector: 'chart-dia-mas-ingresos',
  templateUrl: './dia-mas-ingresos.component.html',
  styleUrl: './dia-mas-ingresos.component.css',
})
export class DiaMasIngresosComponent
  implements AfterViewInit, OnDestroy, OnChanges
{
  @ViewChild('chartContainer', { static: false })
  chartContainer!: ElementRef<HTMLDivElement>;

  @Input() ventasPorDia: VentaPorDia[] = [];

  diaMasVentas: VentaPorDia | null = null;
  private chart: IChartApi | null = null;
  private baselineSeries: any = null;
  private resizeObserver: ResizeObserver | null = null;
  private legendElement: HTMLDivElement | null = null;

  ngAfterViewInit(): void {
    this.initializeChart();
    this.setupResizeObserver();
  }

  /**
   * Se ejecuta cuando los @Input cambian
   */
  ngOnChanges(changes: SimpleChanges): void {
    if (changes['ventasPorDia'] && this.chart && this.baselineSeries) {
      this.updateChartData();
    }
    if (changes['ventasPorDia'] && this.ventasPorDia.length > 0) {
      this.identificarDiaConMasVentas();
    }
  }

  private initializeChart(): void {
    if (!this.chartContainer) return;

    const horzBehaviour = new HorzScaleBehaviorWeek();
    const container = this.chartContainer.nativeElement;
    const width = container.clientWidth;
    const height = 300;
    this.chart = createChartEx(
      container,
      horzBehaviour as unknown as import('lightweight-charts').IHorzScaleBehavior<unknown>,
      {
        width,
        height,
        layout: {
          background: { color: '#fff' },
          textColor: '#000',
        },
        // Ocultar la marca de agua (por defecto la librería puede mostrarla)
        watermark: { visible: false },
      } as any
    );

    this.chart.applyOptions({
      rightPriceScale: {
        scaleMargins: {
          top: 0.4, // Espacio para la leyenda
          bottom: 0.15,
        },
      },
      crosshair: {
        horzLine: {
          visible: false,
          labelVisible: false,
        },
      },
      grid: {
        vertLines: {
          visible: false,
        },
        horzLines: {
          visible: false,
        },
      },
    } as any);

    this.baselineSeries = this.chart.addSeries(BaselineSeries, {
      baseValue: { type: 'price', price: 50 },
      topLineColor: 'rgba(38, 166, 154, 0.8)',
      topFillColor1: 'rgba(38, 166, 154, 0.28)',
      topFillColor2: 'rgba(38, 166, 154, 0.05)',
      bottomLineColor: 'rgba(239, 83, 80, 0.8)',
      bottomFillColor1: 'rgba(239, 83, 80, 0.05)',
      bottomFillColor2: 'rgba(239, 83, 80, 0.28)',
    });

    this.createLegend();
    this.updateChartData();
  }

  /**
   * Actualiza los datos del gráfico
   */
  private updateChartData(): void {
    if (!this.baselineSeries || this.ventasPorDia.length === 0) return;

    // Mapear los datos `ventasPorDia` a items del gráfico
    // Usamos `numeroDia` como 'time' y `totalVentas` como value
    const seriesData = this.ventasPorDia.map((d) => ({
      time: d.numeroDia,
      value: d.totalVentas,
    }));

    this.baselineSeries.setData(seriesData as any);
    this.chart?.timeScale().fitContent();
  }

  private getContainerDimensions(container: HTMLDivElement): {
    width: number;
    height: number;
  } {
    return {
      width: container.clientWidth || 400,
      height: 300,
    };
  }

  private setupResizeObserver(): void {
    if (!this.chartContainer?.nativeElement || !this.chart) {
      return;
    }

    this.resizeObserver = new ResizeObserver(() => {
      const container = this.chartContainer.nativeElement;
      const { width, height } = this.getContainerDimensions(container);
      this.chart?.applyOptions({ width, height });
    });

    this.resizeObserver.observe(this.chartContainer.nativeElement);
  }

  /**
   * Identifica el día con más ventas ordenando el array por totalVentas de mayor a menor
   */
  private identificarDiaConMasVentas(): void {
    if (!this.ventasPorDia || this.ventasPorDia.length === 0) {
      this.diaMasVentas = null;
      return;
    }

    // Ordenar por totalVentas de mayor a menor y tomar el primero
    const diaMaximo = [...this.ventasPorDia].sort(
      (a, b) => b.totalVentas - a.totalVentas
    )[0];

    this.diaMasVentas = diaMaximo;
  }

  /**
   * Formatea un número como moneda en formato COP (Colombia)
   * @param valor Valor numérico a formatear
   * @returns Valor formateado como moneda
   */
  formatearMoneda(valor: number): string {
    if (!valor) {
      return '$ 0';
    }
    return valor.toLocaleString('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  /**
   * Crea el elemento de leyenda posicionado en la esquina superior izquierda del gráfico
   */
  private createLegend(): void {
    if (!this.chartContainer) return;

    this.legendElement = document.createElement('div');
    this.legendElement.style.position = 'absolute';
    this.legendElement.style.left = '12px';
    this.legendElement.style.top = '12px';
    this.legendElement.style.zIndex = '1';
    this.legendElement.style.fontSize = '14px';
    this.legendElement.style.fontFamily = 'sans-serif';
    this.legendElement.style.lineHeight = '18px';
    this.legendElement.style.fontWeight = '300';
    this.legendElement.style.color = '#000';

    this.chartContainer.nativeElement.appendChild(this.legendElement);

    // Suscribirse a movimientos del crosshair para actualizar la leyenda
    if (this.chart) {
      this.chart.subscribeCrosshairMove((param) => this.updateLegend(param));
      // Mostrar la leyenda inicial
      this.updateLegend(undefined);
    }
  }

  /**
   * Actualiza la leyenda con los datos del punto actual o del último bar
   * @param param Parámetro del evento crosshairMove
   */
  private updateLegend(param: any): void {
    if (!this.legendElement || !this.baselineSeries) return;

    const validCrosshairPoint = !(
      param === undefined ||
      param.time === undefined ||
      param.point.x < 0 ||
      param.point.y < 0
    );

    const bar = validCrosshairPoint
      ? param.seriesData.get(this.baselineSeries)
      : this.getLastBar(this.baselineSeries);

    if (!bar) {
      this.legendElement.innerHTML = '';
      return;
    }

    const time = bar.time;
    const value = bar.value !== undefined ? bar.value : 0;

    // Encontrar el día correspondiente para obtener información adicional
    const diaDatos = this.ventasPorDia.find((d) => d.numeroDia === time);
    const nombreDia = diaDatos?.diaSemana || `Día ${time}`;
    const cantidadVentas = diaDatos?.cantidadVentas || 0;

    const formattedValue = this.formatearMoneda(value);

    this.legendElement.innerHTML = `
      <div style="font-size: 16px; margin: 4px 0px; font-weight: bold;">${nombreDia}</div>
      <div style="font-size: 18px; margin: 4px 0px; color: #26a69a;">Total Ventas: ${formattedValue}</div>
      <div style="font-size: 14px; margin: 4px 0px; color: #666;">Cantidad: ${cantidadVentas} ventas</div>
    `;
  }

  /**
   * Obtiene el último bar de la serie
   * @param series Serie del gráfico
   * @returns Datos del último bar
   */
  private getLastBar(series: any): any {
    const lastIndex = series.dataByIndex(Number.MAX_SAFE_INTEGER, -1);
    return series.dataByIndex(lastIndex);
  }

  ngOnDestroy(): void {
    if (this.resizeObserver) {
      this.resizeObserver.disconnect();
    }
    if (this.legendElement && this.legendElement.parentNode) {
      this.legendElement.parentNode.removeChild(this.legendElement);
    }
  }
}
