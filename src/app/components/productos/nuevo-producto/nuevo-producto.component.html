<div class="container contenedorGeneral mt-4 mb-5">
  <div class="formulario">
    <div class="encabezado">
      <h1 class="nota">Registro de productos</h1>
      <p class="text-muted mb-2">Recuerde ingresar todos los campos</p>
    </div>
    <form [formGroup]="formulario" (ngSubmit)="onSubmit()">
      <!-- Grid de 2 columnas para campos principales -->
      <div class="form-grid">
        <!-- Código (con botón de cámara dentro) -->
        <div class="form-group field">
          <label class="form-label">Código</label>
          <div class="d-flex align-items-center" style="gap:8px;">
            <input type="text" id="codigo" class="form-control" pattern="[a-zA-Z0-9]*" formControlName="codigo" placeholder="Código"
              (change)="validarCodigo( $event )" (keyup)="validarCodigo( $event )">
            <button type="button" class="btn camera-btn" (click)="abrirCamara()" aria-label="Abrir cámara">
              <i class="fa-solid fa-camera"></i>
            </button>
          </div>
          <span class="text-danger"
            *ngIf="formulario.get('codigoExistente') && formulario.get('codigoExistente')!.errors && formulario.get('codigoExistente')!.touched">
            El código ya existe
          </span>
          <span class="text-danger"
            *ngIf="formulario.get('codigo') && formulario.get('codigo')!.errors && formulario.get('codigo')!.touched">
            Por favor, ingrese un valor válido.
          </span>
        </div>

        <!-- Nombre -->
        <div class="form-group field">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" formControlName="nombre" placeholder="Nombre">
          <span class="text-danger"
            *ngIf="formulario.get('nombre') && formulario.get('nombre')!.errors && formulario.get('nombre')!.touched">
            Por favor, ingrese un nombre válido
          </span>
        </div>

        <!-- Fecha de vencimiento -->
        <div class="form-group field">
          <label class="form-label">Fecha de vencimiento</label>
          <input type="date" class="form-control" formControlName="fecha_vencimiento" placeholder="Fecha de Vencimiento">
        </div>

        <!-- Lote -->
        <div class="form-group field">
          <label class="form-label">Lote</label>
          <input type="text" class="form-control" formControlName="lote" placeholder="Lote">
        </div>

        <!-- Tipo de impuesto: ocupa las 2 columnas -->
        <div class="form-group field full-span">
          <label class="form-label">Tipo de impuesto</label>
          <select class="form-select" formControlName="impuesto">
            <option value="" disabled selected>Seleccione un impuesto</option>
            <option *ngFor="let impuesto of tipoImpuesto; let i = index" [value]="i">{{impuesto}}</option>
          </select>
        </div>
      </div>
    <!-- Nuevo Componente -->
    <div class="title-with-info d-flex justify-content-center align-items-center" style="gap:8px;">
      <h4 class="mt-2 mb-0">Formas de compra y venta</h4>
      <div class="info-wrapper">
        <button type="button" class="info-icon" aria-label="Información formas">i</button>
        <div class="tooltip-box" role="tooltip">A continuación podrá describir de qué maneras compró y cómo se va a vender el producto, definir el valor neto y a qué precios se van a vender cada tipo de producto; Ej: (Cajas, Sellos, Unidades)</div>
      </div>
    </div>



    <div class="mb-2">
      <button type="button" class="btn-lg mt-0 formulario w-100 add-form-button" id="blanco" (click)="agregarFila()">Agregar forma</button>
    </div>

  <!-- Formas de venta: tabla con un único encabezado; la tabla puede romper el ancho del formulario -->
  <div formArrayName="formasVenta" class="formasVenta">
    <div class="formas-table-wrapper">
      <table class="formas-table" role="table">
        <thead>
          <tr>
            <th scope="col">Nombre</th>
            <th scope="col">Valor compra</th>
            <th scope="col">Precio venta</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Mínimo en stock</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let forma of formasVenta.controls; let i = index" [formGroupName]="i">
            <td>
              <input type="text" class="form-control" formControlName="nombre" placeholder="Ej.: Caja, Unidad, Sello">
            </td>
            <td>
              <input type="text" (input)="formatearValor($event)" class="form-control" formControlName="precioCompra" placeholder="Ej.: 12000">
            </td>
            <td>
              <input type="text" (input)="formatearValor($event)" class="form-control" formControlName="precioVenta" placeholder="Ej.: 15000">
            </td>
            <td>
              <input type="number" min="0" class="form-control" formControlName="cantidad" placeholder="Ej.: 12">
            </td>
            <td>
              <input type="number" min="0" class="form-control" formControlName="minimoDisponible" placeholder="Ej.: 2">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-link btn-delete" (click)="eliminarFila(i)" aria-label="Eliminar forma">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="18" height="18" viewBox="0,0,256,256" aria-hidden="true">
                  <g fill="#ff0000" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10">
                    <g transform="scale(8,8)">
                      <path d="M12.21875,10.78125l-1.4375,1.4375l3.78125,3.78125l-3.78125,3.78125l1.4375,1.4375l3.78125,-3.78125l3.78125,3.78125l1.4375,-1.4375l-3.78125,-3.78125l3.78125,-3.78125l-1.4375,-1.4375l-3.78125,3.78125z"></path>
                    </g>
                  </g>
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="finFormulario mt-3">
    <button class="btn-lg mt-3 w-100" type="submit" id="azul">Guardar producto</button>
  </div>

  </form>
  </div>
</div>
