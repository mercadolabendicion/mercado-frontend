<div class="formulario">
  <div class="row">
    <div class="col-8">
      <h1>Hacer una venta</h1>
    </div>

    <!-- Botones de control de balanza -->
    <div class="col-4 d-flex gap-2 mb-2 align-items-center justify-content-end">
      <button *ngIf="!balanzaConectada" class="btn-md px-2 d-none d-md-flex" id="verde" (click)="conectarBalanza()"
        type="button">
        <i class="fa-solid fa-weight-scale me-1"></i> Conectar Balanza
      </button>

      <!-- Indicador de estado de la balanza -->
      <span *ngIf="balanzaConectada">
        <div>
          <span class="text-dark" style="font-size: 2rem; font-weight: 600">
            {{ pesoActual | number:'1.3-3' }}
          </span> kg
          <span *ngIf="!pesoEstable" class="ms-1 text-dark"
            style="font-size: 0.8rem; font-weight: 600;">(Inestable)</span>
        </div>
      </span>

      <button class="btn btn-primary bg-transparent text-primary border-0" (click)="abrirCamara()">
        <i class="fa-solid fa-camera"></i>
      </button>
    </div>
  </div>

  <div class="productos my-3">
    <div [formGroup]="productosForm">
      <div class="row">
        <div class="col-12 position-relative">
          <input #inputProducto class="form-control" type="text" formControlName="codigoProducto" id="codigoProducto"
            placeholder="Busque aquí el producto, escribiendo el nombre o escaneando el codigo de barras"
            (input)="filtrarProductos()" (keyup)="patchearProducto()" (paste)="patchearProducto()" appAutofocus>
          <div class="popup position-absolute w-100" *ngIf="productosFiltrados.length > 0">
            <ul class="list-group">
              <li class="list-group-item" *ngFor="let producto of productosFiltrados"
                (click)="seleccionarProductoDeLista(producto)">
                {{ producto.codigo }} - {{ producto.nombre }}
              </li>
            </ul>
          </div>
        </div>
        <span *ngIf="cantidadDisponible" class="text-black">
          Quedan: {{ cantidadDisponible }} {{productoDisponible}}
        </span>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Columna 1: Artículos escaneados -->
    <div class="col-lg-8 col-12">
      <div class="card">
        <h5 class="mb-4" style="font-weight: bold;">Artículos escaneados</h5>
        <div class="table-container">
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th class="align-middle">Producto</th>
                  <th class="align-middle text-center">Forma de venta</th>
                  <th class="align-middle text-center">Cantidad</th>
                  <th class="align-middle text-center">Precio</th>
                  <th class="align-middle text-center"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of listProductos; let i = index; trackBy: trackByCodigo" class="align-middle">
                  <td class="venta-nombre align-middle">
                    <strong>{{ producto.nombre }}</strong><br>
                    <span class="venta-codigo">{{ producto.codigo }}</span>
                  </td>
                  <td class="align-middle">
                    <div class="venta-forma-venta" *ngIf="editandoFormaVentaIndex !== i; else editCombo">
                      <span (click)="activarEdicionFormaVenta(i)" class="venta-forma-venta-badge">
                        {{ producto.formaVenta }}
                        <i class="bi bi-pencil ms-1"></i>
                      </span>
                    </div>
                    <ng-template #editCombo>
                      <select class="form-select form-select-sm w-100" [ngModel]="producto.formaVenta"
                        (ngModelChange)="cambiarFormaVenta(i, $event)">
                        <option *ngFor="let forma of getFormasVentaProducto(producto)" [value]="forma.nombre">
                          {{ forma.nombre }}
                        </option>
                      </select>
                      <button class="btn btn-link btn-sm" (click)="desactivarEdicionFormaVenta()"><i
                          class="fa-solid fa-check"></i></button>
                    </ng-template>
                  </td>
                  <td class="align-middle">
                    <div class="d-flex align-items-center justify-content-center">
                      <button class="btn-md me-1 px-2" id="blanco" (click)="cambiarCantidad(i, producto.cantidad - 1)"
                        *ngIf="producto.cantidad > 1">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                      <input type="number" class="form-control form-control-sm text-center venta-cantidad-input mx-2"
                        [value]="producto.cantidad" (input)="cambiarCantidad(i, obtenerValorInputNumber($event))"
                        (focus)="onCantidadFocusCarrito(i)" (blur)="onCantidadBlurCarrito()" min="0" step="0.001"
                        [max]="getCantidadDisponible(producto)" placeholder="0.000">

                      <button class="btn-md me-1 px-2" id="blanco" (click)="cambiarCantidad(i, producto.cantidad + 1)"
                        *ngIf="producto.cantidad < getCantidadDisponible(producto)">
                        <i class="fa-solid fa-plus"></i>
                      </button>
                    </div>
                    <div *ngIf="producto.cantidad > getCantidadDisponible(producto)"
                      class="text-danger small text-center mt-1">
                      *Valor mayor al stock disponible
                    </div>
                  </td>
                  <td class="align-middle text-center">${{ producto.precio | number:'1.0-0' }}</td>
                  <td class="align-middle text-center">
                    <button class="btn btn-danger venta-btn-eliminar" (click)="eliminarPorId(producto)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="sin-datos-tabla" *ngIf="listProductos.length === 0">
                  <td colspan="6">
                    <div class="sin-datos-mensaje">No se han agregado productos</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Columna 2: Cliente, descuento y totales -->
    <div class="col-lg-4 col-12">
      <div class="card">
        <form [formGroup]="formulario" (ngSubmit)="onSubmit()">
          <h5 class="mb-4" style="font-weight: bold;">Resumen de la venta</h5>
          <div class="row gy-3 align-items-center">
            <!-- Cédula del cliente -->
            <div class="row">

            </div>
            <div class="col-12 position-relative mb-2">
              <p for="cliente">Cédula del cliente:</p>
              <input class="form-control" type="text" formControlName="cliente" id="cedulaCliente"
                (input)="filtrarClientes()" placeholder="Ej. 123456789">
              <!-- Lista flotante -->
              <div class="popup position-absolute w-100" *ngIf="clientesFiltrados.length > 0">
                <ul class="list-group">
                  <li class="list-group-item" *ngFor="let cliente of clientesFiltrados"
                    (click)="seleccionarClienteDeLista(cliente)">
                    {{ cliente.cedula }} - {{ cliente.nombre }}
                  </li>
                </ul>
              </div>
              <span
                *ngIf="formulario.get('cliente')?.invalid && (formulario.get('cliente')?.dirty || formulario.get('cliente')?.touched)">
                Por favor, ingrese un valor válido.
              </span>
            </div>
            <!-- Nombre y dirección del cliente en la misma fila, como texto -->
            <div class="row mb-2">
              <div class="col-12 d-flex justify-content-between align-items-center">
                <span class="fw-semibold fs-6 text-black">Nombre:</span>
                <span class="fs-6 text-black">{{ clienteSeleccionado?.nombre || '-' }}</span>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-12 d-flex justify-content-between align-items-center">
                <span class="fw-semibold fs-6 text-black">Dirección:</span>
                <span class="fs-6 text-black">{{ clienteSeleccionado?.direccion || '-' }}</span>
              </div>
            </div>
          </div>
          <p type="button" class="mt-1 mb-5" id="gris" data-bs-toggle="modal" data-bs-target="#agregarUsuarioModal">
            ¿No encuentras el cliente? Puedes crearlo <u><b>Aquí</b></u>
          </p>
        </form>
        <hr class="opacity-60">
        <div class="row">
          <!-- Totales -->
          <div class="col-12">
            <div class="valores-a-pagar">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold fs-6 text-black">Descuento:</span>
                <span class="fs-6 text-black">${{valorDescuento}}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-semibold fs-6 text-black">Total a pagar:</span>
                <span class="fs-2 text-black">${{total | number: '1.0-0' }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn-lg w-100" id="verde" (click)="onSubmit()">Vender</button>
        </div>
        <!-- Columna del checkbox y descuento -->
        <div class="col-12 mt-2">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="applyDiscountCheckbox" [(ngModel)]="aplicarDescuento"
              name="aplicarDescuento" />
            <label class="form-check-label ms-2" for="applyDiscountCheckbox">
              Mostrar descuento
            </label>
          </div>
          <div class="mb-2" *ngIf="aplicarDescuento">
            <input type="text" class="form-control" id="discountValue" [value]="valorFormateado"
              (input)="formatearValor($event)" [(ngModel)]="valorDescuento" placeholder="Ingrese el valor del descuento"
              name="valorDescuento" />
          </div>
          <div *ngIf="aplicarDescuento">
            <button class="btn-lg w-100 mb-2" id="azul" (click)="reducirTotal()">Aplicar
              descuento</button>
          </div>
          <div *ngIf="descuentoAplicado">
            <button class="btn-lg w-100 mb-2" id="rojo" (click)="cancelarDescuento()">Cancelar
              descuento</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="nuevo-usuario" [ngClass]="{ 'oculto': modoOculto }">
    <span class="cerrar" (click)="cambiarModoOculto()">❌</span>
    <app-nuevo></app-nuevo>
  </div>
</div>

<div class="modal fade" id="agregarUsuarioModal" tabindex="-1" aria-labelledby="agregarUsuarioModalLabel"
  aria-hidden="true" #modal>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="agregarUsuarioModalLabel">Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body StyleModal">
        <app-nuevo></app-nuevo>
      </div>
    </div>
  </div>
</div>
